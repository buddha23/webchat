<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lld360.cnc.repository.UserStatementTempDao">

    <!-- 定义全局查询的SQL变量语句 -->
    <sql id="searchCondition">
        <where>
            <if test="userId != null">AND userId = #{userId}</if>
            <if test="tradeTime != null">AND trade_time = #{tradeTime}</if>
            <if test="tradeAmount != null">AND trade_amount = #{tradeAmount}</if>
            <if test="tradeState != null and tradeState != ''">
                AND trade_state LIKE "%"#{tradeState}"%"
            </if>
            <if test="tradeRemark != null and tradeRemark != ''">
                AND trade_remark LIKE "%"#{tradeRemark}"%"
            </if>
            <if test="innerTradeNo != null and innerTradeNo != ''">
                AND inner_trade_no LIKE "%"#{innerTradeNo}"%"
            </if>
            <if test="tradeNo != null and tradeNo != ''">
                AND trade_no LIKE "%"#{tradeNo}"%"
            </if>
            <if test="payType != null and payType != ''">
                AND pay_type LIKE "%"#{payType}"%"
            </if>
        </where>
    </sql>

    <!-- 通用查询结果列-->
    <sql id="columns">
        <![CDATA[
        id,
        user_id,
        trade_time,
        trade_amount,
        trade_state,
        trade_remark,
        inner_trade_no,
        trade_no,
        pay_type,
        buy_score,
        present_score,
        trade_type,
        object_id
        ]]>
    </sql>

    <sql id="selectColumns">
        SELECT
        <include refid="columns"/>
        FROM user_statement_temp
    </sql>

    <select id="findByInnerTradeNo" parameterType="string" resultMap="userStatementMap">
        <include refid="selectColumns"/>
        WHERE inner_trade_no = #{innerTradeNo}
    </select>

    <insert id="create" parameterType="com.lld360.cnc.model.UserStatement" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO user_statement_temp (
            user_id,
            trade_time,
            trade_amount,
            trade_state,
            trade_remark,
            inner_trade_no,
            trade_no,
            pay_type,
            buy_score,
            present_score,
            trade_type,
            object_id
        ) VALUES (
            #{userId},
            #{tradeTime},
            #{tradeAmount},
            #{tradeState},
            #{tradeRemark},
            #{innerTradeNo},
            #{tradeNo},
            #{payType},
            #{buyScore},
            #{presentScore},
            #{tradeType},
            #{objectId}
        )
    </insert>

    <delete id="delete" parameterType="long">
        DELETE FROM user_statement_temp WHERE id = #{id}
    </delete>
    
    <delete id="deleteOverdue">
        DELETE FROM user_statement_temp where trade_time &lt; DATE_ADD(now(), Interval -5 day);
    </delete>

    <select id="count" parameterType="map" resultType="long">
        SELECT count(1)
        FROM user_statement_temp
        <include refid="searchCondition"/>
    </select>

    <select id="search" parameterType="map" resultMap="userStatementMap">
        <include refid="selectColumns"/>
        <include refid="searchCondition"/>
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="searchRows" parameterType="map" resultMap="userStatementMap">
        <include refid="selectColumns"/>
        <include refid="searchCondition"/>
    </select>

    <!-- 结果集mapper -->
    <resultMap id="userStatementMap" type="com.lld360.cnc.model.UserStatement">
        <result property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="tradeTime" column="trade_time"/>
        <result property="tradeAmount" column="trade_amount"/>
        <result property="tradeState" column="trade_state"/>
        <result property="tradeRemark" column="trade_remark"/>
        <result property="innerTradeNo" column="inner_trade_no"/>
        <result property="tradeNo" column="trade_no"/>
        <result property="payType" column="pay_type"/>
        <result property="buyScore" column="buy_score"/>
        <result property="presentScore" column="present_score"/>
        <result property="tradeType" column="trade_type"/>
        <result property="objectId" column="object_id"/>
    </resultMap>

</mapper>