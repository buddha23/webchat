<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lld360.cnc.repository.VodVolumesDao">

    <!-- 定义全局查询的SQL变量语句 -->
    <sql id="searchCondition">
        <where>
            <if test="name != null">AND v.`name` LIKE "%"#{name}"%"</if>
            <if test="lecturer != null">AND v.lecturer LIKE "%"#{lecturer}"%"</if>
            <if test="duration != null">AND v.duration = #{duration}</if>
            <if test="costScore != null">AND v.cost_score = #{costScore}</if>
            <if test="caterogyId != null">AND v.caterogy_id = #{caterogyId}</if>
            <if test="workflow != null">AND v.workflow = #{workflow}</if>
            <if test="creater != null">AND v.creater = #{creater}</if>
            <if test="createTime != null">AND v.create_time = #{createTime}</if>
            <if test="updateTime != null">AND v.update_time = #{updateTime}</if>
            <if test="state != null">AND v.state = #{state}</if>
            <if test="c1 != null">AND c.fid=#{c1}</if>
            <if test="c2 != null">AND c.id=#{c2}</if>
            <if test="tagId != null">AND vxt.`tag_id` = #{tagId}</if>
        </where>
    </sql>

    <!-- 用于select查询公用抽取的列 -->
    <sql id="columns">
	    <![CDATA[
        v.id,
        v.`name`,
        v.cover,
        v.lecturer,
        v.duration,
        v.summary,
        v.introduction,
        v.content,
        v.cost_score,
        v.caterogy_id,
        v.workflow,
        v.creater,
        v.create_time,
        v.update_time,
        v.state,
        v.`sorting`,
        v.`lecturer_id`,
        v.`lecturer_profit`,
        v.`views`
        ]]>
	</sql>

    <select id="search" parameterType="map" resultMap="vodvolumesMap">
        SELECT DISTINCT
        <include refid="columns"/>,
        COUNT(s.`id`) totleNum
        FROM vod_volumes v
        LEFT JOIN vod_category c ON c.id = v.caterogy_id
        LEFT JOIN `vod_x_tag` vxt ON vxt.`volume_id` = v.`id`
        LEFT JOIN `vod_chapters` vc ON vc.`volume_id` = v.`id`
        LEFT JOIN `vod_section` s ON vc.`id` = s.`chapter_id`
        <include refid="searchCondition"/>
        GROUP BY v.`id`
        ORDER BY v.`sorting`,v.create_time DESC
        <if test="limit != null">LIMIT #{limit}</if>
        <if test="offset != null">OFFSET #{offset}</if>
    </select>

    <select id="count" parameterType="map" resultType="long">
        SELECT count(1)
        FROM vod_volumes v
        LEFT JOIN vod_category c ON c.id = v.caterogy_id
        LEFT JOIN `vod_x_tag` vxt ON vxt.`volume_id` = v.`id`
        <include refid="searchCondition"/>
    </select>

    <!-- 管理端视频集列表对象 -->
    <sql id="volumeDtoSearchCondition">
        <where>
            <if test="key != null">AND v.`name` LIKE "%"#{key}"%"</if>
            <if test="state != null">AND v.state = #{state}</if>
            <if test="tagId != null and tagId != 0">AND t.id = #{tagId}</if>
        </where>
    </sql>

    <select id="countVolumeDto" resultType="java.lang.Integer" parameterType="map">
        SELECT
        COUNT(DISTINCT v.id)
        FROM vod_volumes v
        LEFT JOIN vod_buys b ON b.`volume_id` = v.`id`
        LEFT JOIN vod_chapters c ON c.`volume_id` = v.`id`
        LEFT JOIN vod_section s ON s.`chapter_id` = c.`id`
        LEFT JOIN `vod_x_tag` vxt ON vxt.`volume_id` = v.`id`
        LEFT JOIN `vod_tag` t ON t.`id` = vxt.`tag_id`
        <include refid="volumeDtoSearchCondition"/>
    </select>

    <select id="searchVolumeDto" resultType="com.lld360.cnc.dto.VolumeDto" parameterType="map">
        SELECT
        v.id,
        v.name,
        v.cover,
        v.`lecturer`,
        v.`duration`,
        v.`summary`,
        v.`introduction`,
        v.`content`,
        v.`cost_score`,
        v.`workflow`,
        v.`creater`,
        v.`create_time`,
        v.`update_time`,
        v.`state`,
        v.`sorting`,
        v.`lecturer_id`,
        v.`lecturer_profit`,
        v.`views`,
        COUNT(DISTINCT c.id) chapterCount,
        COUNT(s.id) sectionCount,
        COUNT(DISTINCT b.user_id) buysCount
        FROM vod_volumes v
        LEFT JOIN vod_buys b ON b.`volume_id` = v.`id`
        LEFT JOIN vod_chapters c ON c.`volume_id` = v.`id`
        LEFT JOIN vod_section s ON s.`chapter_id` = c.`id`
        LEFT JOIN `vod_x_tag` vxt ON vxt.`volume_id` = v.`id`
        LEFT JOIN `vod_tag` t ON t.`id` = vxt.`tag_id`
        <include refid="volumeDtoSearchCondition"/>
        GROUP BY v.`id`
        <if test="sortCol != null">
            <if test="sortCol == 'buys'">
                ORDER BY buysCount ${sortBy}
            </if>
            <if test="sortCol == 'createTime'">
                ORDER BY v.create_time ${sortBy}
            </if>
        </if>
        <if test="sortCol == null">
            ORDER BY v.`create_time` DESC
        </if>
        <if test="limit != null">LIMIT #{limit}</if>
        <if test="offset != null">OFFSET #{offset}</if>
    </select>
    <!-- 管理端视频集列表对象 结束 -->

    <select id="find" parameterType="int" resultMap="vodvolumesMap">
        SELECT
        <include refid="columns"/>,
        u.`nickname`
        FROM vod_volumes v
        LEFT JOIN user u ON v.`creater` = u.`id`
        WHERE v.id = #{id}
    </select>

    <sql id="columnWithSection">
        v.id,
        v.name,
        v.cover,
        v.`lecturer`,
        v.`duration`,
        v.`summary`,
        v.`introduction`,
        v.`content`,
        v.`cost_score`,
        v.`caterogy_id`,
        v.`workflow`,
        v.`creater`,
        v.`create_time`,
        v.`update_time`,
        v.`state`,
        v.`sorting`,
        v.`lecturer_id`,
        v.`lecturer_profit`,
        v.`views`,
        c.`volume_id`,
        c.`id`       cid,
        c.`name`     cname,
        c.`sorting`  csorting,
        s.`id`       sid,
        s.`chapter_id`,
        s.`vod_name`,
        s.`name`     sname,
        s.`sorting`  ssorting,
        s.`media_id`,
        s.`duration` sduration,
        s.`width`,
        s.`height`,
        s.`bitrate`,
        s.`size`     ssize,
        s.`cover`    scover,
        s.url        surl,
        s.trans_url,
        s.`ext`      sext,
        s.free       sfree,
        s.state      sstate
    </sql>

    <select id="findWithSections" resultMap="vodvolumeWithSectionsMap" parameterType="int">
        SELECT
        <include refid="columnWithSection"/>,
        vt.`id` tid,
        vt.`name` tname,
        vt.`icon` ticon,
        vt.`description` tdescription
        FROM vod_volumes v
        LEFT JOIN vod_chapters c ON c.`volume_id` = v.`id`
        LEFT JOIN vod_section s ON s.`chapter_id` = c.`id`
        LEFT JOIN `vod_x_tag` vxt ON v.`id` = vxt.`volume_id`
        LEFT JOIN `vod_tag` vt ON vt.`id` = vxt.`tag_id`
        WHERE v.id = #{id}
        ORDER BY c.`sorting`, s.`sorting`
    </select>

    <select id="searchWithSections" resultMap="vodvolumeWithSectionsMap" parameterType="map">
        SELECT
        <include refid="columnWithSection"/>
        FROM vod_volumes v
        LEFT JOIN vod_chapters c ON c.`volume_id` = v.`id`
        LEFT JOIN vod_section s ON s.`chapter_id` = c.`id`
        <where>
            <if test="state != null">v.state = #{state}</if>
            <if test="sectionState != null">AND s.state = #{sectionState}</if>
        </where>
        ORDER BY c.`sorting`, s.`sorting`
    </select>

    <insert id="create" parameterType="com.lld360.cnc.model.VodVolumes" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO
            vod_volumes (
                `name`,
                cover,
                lecturer,
                duration,
                summary,
                introduction,
                content,
                cost_score,
                caterogy_id,
                workflow,
                creater,
                create_time,
                update_time,
                state,
                `sorting`,
                `lecturer_id`,
                `lecturer_profit`,
                `views`
            ) VALUES (
                #{name},
                #{cover},
                #{lecturer},
                #{duration},
                #{summary},
                #{introduction},
                #{content},
                #{costScore},
                #{caterogyId},
                #{workflow},
                #{creater},
                #{createTime},
                #{updateTime},
                #{state},
                #{sorting},
                #{lecturerId},
                #{lecturerProfit},
                #{views}
            )
    </insert>

    <update id="update" parameterType="com.lld360.cnc.model.VodVolumes">
        UPDATE vod_volumes
        <set>
            <if test="name != null">name = #{name},</if>
            <if test="cover != null">cover = #{cover},</if>
            <if test="lecturer != null">lecturer = #{lecturer},</if>
            <if test="duration != null">duration = #{duration},</if>
            <if test="summary != null">summary = #{summary},</if>
            <if test="introduction != null">introduction = #{introduction},</if>
            <if test="content != null">content = #{content},</if>
            <if test="costScore != null">cost_score = #{costScore},</if>
            <if test="caterogyId != null">caterogy_id = #{caterogyId},</if>
            <if test="workflow != null">workflow = #{workflow},</if>
            <if test="creater != null">creater = #{creater},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="state != null">state = #{state},</if>
            <if test="sorting != null">sorting = #{sorting},</if>
            <if test="lecturerId != null">lecturer_id = #{lecturerId},</if>
            <if test="lecturerProfit != null">lecturer_profit = #{lecturerProfit},</if>
        </set>
        WHERE id = #{id};
    </update>

    <update id="updateState">
        UPDATE vod_volumes
        SET state = #{state}
        WHERE id = #{id}
    </update>

    <!--根据所有的视频节更新视频集的时长和状态-->
    <update id="updateStateBySections" parameterType="int">
        UPDATE vod_volumes v, (
                                  SELECT
                                      v.id,
                                      SUM(s.`duration`)          duration,
                                      SUM(IF(s.state = 1, 1, 0)) normals,
                                      COUNT(s.id)                sids
                                  FROM vod_volumes v
                                      LEFT JOIN vod_chapters c ON c.`volume_id` = v.`id`
                                      LEFT JOIN vod_section s ON s.`chapter_id` = c.`id`
                                  WHERE v.`id` = #{id}
                                  GROUP BY v.`id`
                              ) t
        SET v.state = IF(t.normals = t.sids, 1, 2), v.`duration` = IFNULL(t.duration, 0)
        WHERE v.id = t.id AND v.`id` = #{id}
    </update>

    <!--根据所有的视频节更新视频集的时长和状态-->
    <update id="updateAllStateBySections">
        UPDATE vod_volumes v, (
                                  SELECT
                                      v.id,
                                      SUM(s.`duration`)          duration,
                                      SUM(IF(s.state = 1, 1, 0)) normals,
                                      COUNT(s.id)                sids
                                  FROM vod_volumes v
                                      LEFT JOIN vod_chapters c ON c.`volume_id` = v.`id`
                                      LEFT JOIN vod_section s ON s.`chapter_id` = c.`id`
                                  WHERE v.`state` = 2
                                  GROUP BY v.`id`
                              ) t
        SET v.state = IF(t.normals = t.sids, 1, 2), v.`duration` = t.duration
        WHERE v.id = t.id AND v.`state` = 2
    </update>

    <delete id="delete" parameterType="long">
        DELETE FROM vod_volumes
        WHERE id = #{id}
    </delete>

    <select id="getVolumeBySectionId" parameterType="long" resultType="com.lld360.cnc.model.VodVolumes">
        SELECT v.*
        FROM `vod_volumes` v
        LEFT JOIN `vod_chapters` vc ON v.`id` = vc.`volume_id`
        LEFT JOIN `vod_section` vs ON vs.`chapter_id` = vc.`id`
        WHERE vs.`id` = #{sectionId}
    </select>

    <update id="addViews">
        UPDATE `vod_volumes` v
        SET v.`views` = v.`views` + 1
        WHERE v.`id` = #{id}
    </update>

    <!-- 结果集mapper -->
    <resultMap id="vodvolumesMap" type="com.lld360.cnc.dto.VodVolumesDto">
        <result property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="cover" column="cover"/>
        <result property="lecturer" column="lecturer"/>
        <result property="duration" column="duration"/>
        <result property="summary" column="summary"/>
        <result property="introduction" column="introduction"/>
        <result property="content" column="content"/>
        <result property="costScore" column="cost_score"/>
        <result property="caterogyId" column="caterogy_id"/>
        <result property="workflow" column="workflow"/>
        <result property="creater" column="creater"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="state" column="state"/>
        <result property="sorting" column="sorting"/>
        <result property="createrName" column="nickname"/>
        <result property="totleNum" column="totleNum"/>
        <result property="lecturerId" column="lecturer_id"/>
        <result property="views" column="views"/>
        <result property="lecturerProfit" column="lecturer_profit"/>
    </resultMap>

    <!-- 包含章节内容的视频集内容 -->
    <resultMap id="vodvolumeWithSectionsMap" type="com.lld360.cnc.model.VodVolumes">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="cover" column="cover"/>
        <result property="lecturer" column="lecturer"/>
        <result property="duration" column="duration"/>
        <result property="summary" column="summary"/>
        <result property="introduction" column="introduction"/>
        <result property="content" column="content"/>
        <result property="costScore" column="cost_score"/>
        <result property="caterogyId" column="caterogy_id"/>
        <result property="workflow" column="workflow"/>
        <result property="creater" column="creater"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="state" column="state"/>
        <result property="sorting" column="sorting"/>
        <result property="lecturerId" column="lecturer_id"/>
        <result property="views" column="views"/>
        <result property="lecturerProfit" column="lecturer_profit"/>
        <collection property="chapters" ofType="com.lld360.cnc.model.VodChapters">
            <id property="id" column="cid"/>
            <result property="volumeId" column="volume_id"/>
            <result property="name" column="cname"/>
            <result property="sorting" column="csorting"/>
            <collection property="vodSections" ofType="com.lld360.cnc.model.VodSection">
                <id property="id" column="sid"/>
                <result property="chapterId" column="chapter_id"/>
                <result property="vodName" column="vod_name"/>
                <result property="name" column="sname"/>
                <result property="sorting" column="ssorting"/>
                <result property="mediaId" column="media_id"/>
                <result property="duration" column="sduration"/>
                <result property="width" column="width"/>
                <result property="height" column="height"/>
                <result property="bitrate" column="bitrate"/>
                <result property="size" column="ssize"/>
                <result property="cover" column="scover"/>
                <result property="url" column="surl"/>
                <result property="transUrl" column="trans_url"/>
                <result property="ext" column="sext"/>
                <result property="free" column="sfree"/>
                <result property="state" column="sstate"/>
            </collection>
        </collection>
        <collection property="tags" ofType="com.lld360.cnc.model.VodTag">
            <id property="id" column="tid"/>
            <result property="name" column="tname"/>
            <result property="description" column="tdescription"/>
            <result property="icon" column="ticon"/>
        </collection>
    </resultMap>

</mapper> 
