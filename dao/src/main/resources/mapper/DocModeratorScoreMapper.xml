<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 版主积分/历史表操作 -->
<mapper namespace="com.lld360.cnc.repository.DocModeratorScoreDao">

    <insert id="createModetatorScore">
        INSERT INTO moderator_score (user_id,contribution_score)
        VALUES (#{userId},#{contributionScore})
    </insert>

    <update id="updateModetatorScore">
        UPDATE moderator_score
        SET contribution_score = contribution_score + (#{scoreChange})
        WHERE user_id = #{userId}
    </update>

    <select id="existModeratorScore" resultType="boolean">
        SELECT (COUNT(user_id) > 0) AS exist
        FROM moderator_score
        WHERE user_id = #{userId}
    </select>

    <!--积分历史-->
    <sql id="searchCondition">
        <where>
            <if test="userId != null">AND m.`user_id` = #{userId}</if>
            <if test="beginTime != null and beginTime != ''">AND m.`create_time` &gt; #{beginTime}</if>
            <if test="endTime != null and endTime != ''">AND m.`create_time` &lt; #{endTime}</if>
            <if test="content != null and content != ''">AND (u.`nickname` LIKE "%"#{content}"%" OR u.`mobile` LIKE "%"#{content}"%")</if>
        </where>
    </sql>

    <select id="getModeratorScoreHistory" parameterType="map" resultType="com.lld360.cnc.model.ModeratorScoreHistory">
        SELECT
        m.*,
        u.`nickname` userNickname
        FROM `moderator_score_history` m
        LEFT JOIN `user` u ON m.`user_id` = u.`id`
        <include refid="searchCondition"/>
        ORDER BY m.`create_time` DESC
        <if test="limit != null and offset != null">LIMIT #{limit} OFFSET #{offset}</if>
    </select>

    <select id="count" parameterType="map" resultType="long">
        SELECT COUNT(1)
        FROM `moderator_score_history` m
        LEFT JOIN `user` u ON m.`user_id` = u.`id`
        <include refid="searchCondition"/>
    </select>

    <insert id="createModeratorScoreHistory" parameterType="com.lld360.cnc.model.ModeratorScoreHistory">
        INSERT INTO moderator_score_history (user_id, type, score_change, object_id, description, create_time)
        VALUES (#{userId}, #{type}, #{scoreChange}, #{objectId}, #{description}, #{createTime})
    </insert>

    <select id="getDailyScore" resultType="long">
        SELECT IFNULL(SUM(score_change), 0) AS score
        FROM `moderator_score_history`
        WHERE user_id = #{userId} AND type = #{type} AND DATE(create_time) = DATE(#{oneday})
    </select>

    <select id="getMonthScore" resultType="long">
        SELECT IFNULL(SUM(score_change), 0) AS score
        FROM `moderator_score_history`
        WHERE user_id = #{userId} AND CONCAT(YEAR(`create_time`),MONTH(`create_time`)) = CONCAT(YEAR(#{oneday}),MONTH(#{oneday}))
    </select>

    <select id="getAllMonthScore" parameterType="map" resultType="com.lld360.cnc.model.ModeratorScoreHistory">
        SELECT
          user_id userId,
          SUM(`score_change`) scoreChange,
          s.`create_time` createTime
        FROM `moderator_score_history` s
        <where>
          <if test="userId != null">AND s.user_id = #{userId}</if>
        </where>
        GROUP BY CONCAT(YEAR(`create_time`),MONTH(s.`create_time`))
        ORDER BY CONCAT(YEAR(`create_time`),MONTH(s.`create_time`)) DESC
    </select>
    
    <select id="count4MonthScore" parameterType="map" resultType="long">
        SELECT count(1)
        FROM (
            SELECT *
            FROM `moderator_score_history` s
            <where>
                <if test="userId != null">AND s.user_id = #{userId}</if>
            </where>
            GROUP BY CONCAT(YEAR(`create_time`),MONTH(s.`create_time`))
            ) monthscore
    </select>

</mapper>